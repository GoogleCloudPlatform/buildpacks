package nodejs

import (
	"github.com/GoogleCloudPlatform/buildpacks/pkg/env"
	gcp "github.com/GoogleCloudPlatform/buildpacks/pkg/gcpbuildpack"
)

// as per https://github.com/vercel/next.js/security/advisories/GHSA-9qr9-h5gf-34mp
var (
	vulnerableNextjsRanges = []string{
		">= 15.0.0-0, < 15.0.5",
		">= 15.1.0-0, < 15.1.9",
		">= 15.2.0-0, < 15.2.6",
		">= 15.3.0-0, < 15.3.6",
		">= 15.4.0-0, < 15.4.8",
		">= 15.5.0-0, < 15.5.7",
		">= 16.0.0-0, < 16.0.7",
		">= 15.6.0-canary.0, < 15.6.0-canary.58",
		">= 16.1.0-canary.0, < 16.1.0-canary.12",
		">= 14.3.0-canary.77, < 15.0.0",
	}

	// as per https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components
	vulnerableRSCRanges = []string{
		">= 19.0.0-0, < 19.0.1",
		">= 19.1.0-0, < 19.1.2",
		">= 19.2.0-0, < 19.2.1",
	}
	targetReactServerPackages = []string{
		"react-server-dom-webpack",
		"react-server-dom-parcel",
		"react-server-dom-turbopack",
	}
)

// CheckVulnerabilities checks for known vulnerable dependencies.
func CheckVulnerabilities(ctx *gcp.Context, nodeDeps *NodeDependencies) error {
	if allow, _ := env.IsPresentAndTrue(env.AllowVulnerableDependencies); allow {
		ctx.Warnf("Skipping vulnerability checks because %s is enabled.", env.AllowVulnerableDependencies)
		return nil
	}

	// Check Next.js version against known vulnerable ranges.
	nextVersion, err := Version(nodeDeps, "next")
	if err != nil {
		ctx.Debugf("Failed to get next version from lockfile: %v", err)
	} else if nextVersion != "" {
		// Check Next.js version against known vulnerable ranges.
		for _, vr := range vulnerableNextjsRanges {
			matches, err := VersionMatchesSemver(ctx, vr, nextVersion)
			if err != nil {
				// Log warning but continue; fail-open preference for buildpacks usually
				ctx.Warnf("could not check for vulnerable Next.js version: %v", err)
				continue
			}
			if matches {
				return gcp.UserErrorf("vulnerable Next.js version %s detected due to CVE-2025-55182. Please upgrade to a patched version (e.g., 15.0.5, 15.1.9, 15.5.7, 16.0.7). See https://github.com/vercel/next.js/security/advisories/GHSA-9qr9-h5gf-34mp for details.", nextVersion)
			}
		}
	}

	// Check React Server components versions against known vulnerable versions.
	for _, pkgName := range targetReactServerPackages {
		rscVersion, err := Version(nodeDeps, pkgName)
		if err != nil {
			ctx.Debugf("Failed to get %s version from lockfile: %v", pkgName, err)
			continue
		}

		// If package not found or error, skip it
		if rscVersion == "" {
			continue
		}

		for _, vr := range vulnerableRSCRanges {
			matches, err := VersionMatchesSemver(ctx, vr, rscVersion)
			if err != nil {
				ctx.Warnf("could not check for vulnerable %s version: %v", pkgName, err)
				continue
			}
			if matches {
				return gcp.UserErrorf("vulnerable %s version %s detected due to CVE-2025-55182. Please upgrade to a patched version (e.g., 19.0.1, 19.1.2, 19.2.1). See https://react.dev/blog/2025/12/03/critical-security-vulnerability-in-react-server-components for details.", pkgName, rscVersion)
			}
		}
	}

	return nil
}
