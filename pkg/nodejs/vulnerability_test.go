package nodejs

import (
	"testing"

	"github.com/GoogleCloudPlatform/buildpacks/pkg/env"
	gcp "github.com/GoogleCloudPlatform/buildpacks/pkg/gcpbuildpack"
	"github.com/GoogleCloudPlatform/buildpacks/pkg/testdata"
)

func TestCheckVulnerabilities(t *testing.T) {
	testCases := []struct {
		name     string
		nodeDeps *NodeDependencies
		env      map[string]string
		wantErr  bool
	}{
		{
			name: "npm_nextjs_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/nextjs-package-lock.json"),
			},
			wantErr: true,
		},
		{
			name: "npm_nextjs_not_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/good-next-package-lock.json"),
			},
			wantErr: false,
		},
		{
			name: "yarn_nextjs_vulnerable",
			nodeDeps: &NodeDependencies{
				PackageJSON: &PackageJSON{
					Dependencies: map[string]string{
						"next": "15.0.0",
					},
				},
				LockfilePath: testdata.MustGetPath("testdata/lock-files/vuln-next-yarn.lock"),
			},
			wantErr: true,
		},
		{
			name: "yarn_nextjs_not_vulnerable",
			nodeDeps: &NodeDependencies{
				PackageJSON: &PackageJSON{
					Dependencies: map[string]string{
						"next": "14.1.4",
					},
				},
				LockfilePath: testdata.MustGetPath("testdata/lock-files/good-next-yarn.lock"),
			},
			wantErr: false,
		},
		{
			name: "pnpm_nextjs_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/vuln-next-pnpm-lock.yaml"),
			},
			wantErr: true,
		},
		{
			name: "pnpm_nextjs_not_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/nextjs-v6-pnpm-lock.yaml"),
			},
			wantErr: false,
		},
		{
			name: "npm_rsc_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/vuln-rsc-package-lock.json"),
			},
			wantErr: true,
		},
		{
			name: "npm_rsc_not_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/good-rsc-package-lock.json"),
			},
			wantErr: false,
		},
		{
			name: "npm_nextjs_canary_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/vuln-next-canary-package-lock.json"),
			},
			wantErr: true,
		},
		{
			name: "npm_rsc_canary_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/vuln-rsc-canary-package-lock.json"),
			},
			wantErr: true,
		},
		{
			name: "pnpm_rsc_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/vuln-rsc-pnpm-lock.yaml"),
			},
			wantErr: true,
		},
		{
			name: "pnpm_rsc_not_vulnerable",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/good-rsc-pnpm-lock.yaml"),
			},
			wantErr: false,
		},
		{
			name:     "no_lock_file",
			nodeDeps: &NodeDependencies{LockfilePath: "non-existent-lock-file"},
			wantErr:  false,
		},
		{
			name: "vulnerable_dependency_allowed_via_env_var",
			nodeDeps: &NodeDependencies{
				LockfilePath: testdata.MustGetPath("testdata/lock-files/nextjs-package-lock.json"),
			},
			env:     map[string]string{env.AllowVulnerableDependencies: "true"},
			wantErr: false,
		},
	}

	for _, tc := range testCases {
		t.Run(tc.name, func(t *testing.T) {
			for k, v := range tc.env {
				t.Setenv(k, v)
			}
			ctx := gcp.NewContext()
			err := CheckVulnerabilities(ctx, tc.nodeDeps)
			if !tc.wantErr && err != nil {
				t.Errorf("CheckVulnerabilities() got error: %v, want no error", err)
			}
			if tc.wantErr && err == nil {
				t.Errorf("CheckVulnerabilities() got no error, want error")
			}
		})
	}
}
